---
title: "Treatment"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Treatment}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
suppressPackageStartupMessages(library(ggplot2))
library(malariasimulation)
library(malariaEquilibrium)
library(reshape2)
suppressPackageStartupMessages(library(cowplot))
```

Set up some baseline parameters:

```{r}
year <- 365
sim_length <- 50 * year
human_population <- 1000
repetitions <- 5

jamie_params <- load_parameter_set()

simparams <- get_parameters(c(
  translate_jamie(remove_unused_jamie(jamie_params)),
  list(
    human_population = human_population,
    variety_proportions = 1,
    vector_ode = TRUE
  )
))
simparams <- set_drugs(simparams, list(AL_params, DHC_PQP_params))

# NOTE: this equilibrium is calculated using an old model of prophylaxis
# it is just used as a starting point
get_equilibrium <- function(EIR, ft) {
  human_equilibrium(EIR = EIR, ft = ft, p = jamie_params, age = 0:99)
}
```

Run the model for some starting EIRs and fts:

```{r}
outputs <- list()
eirs <- c(1, 10)
fts <- c(0, .25, .5, .75, 1.)

for (EIR in eirs) {
  for (ft in fts) {
    eq <- get_equilibrium(EIR, ft)
    simparams <- parameterise_human_equilibrium(simparams, eq)
    simparams <- parameterise_mosquito_equilibrium(simparams, EIR)
    simparams <- set_clinical_treatment(simparams, ft, c(1, 2), c(.5, .5))
    output <- run_simulation_with_repetitions(
      sim_length,
      repetitions,
      simparams,
      parallel=FALSE
    )
    outputs[[length(outputs) + 1]] <- output
  }
}
```

Let's plot the effect of ft on the relationship between EIR and PfPrev2-10:

```{r}

prevs <- vapply(
  outputs,
  function(output) {
    mean(vapply(
      seq(repetitions),
      function(r) {
        mean(
          tail(
            subset(output, output$repetition == r)$prev_2_10,
            year
          )
        ) / simparams$human_population
      },
      numeric(1)
    ))
  },
  numeric(1)
)

applied_fts <- rep(fts, each=length(eirs))

ggplot(
  data.frame(eir = eirs, prev = prevs, ft = applied_fts)
) + geom_line(
  aes(x = eir, y = prev, group = ft, colour = ft)
) + scale_x_continuous(trans='log10')
```